<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë£¨ì‹œë”” - ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      body {
        background-color: #0f172a; /* slate-900 */
        color: white;
        font-family: "Pretendard Variable", Pretendard, -apple-system,
          BlinkMacSystemFont, system-ui, Roboto, "Helvetica Neue", "Segoe UI",
          "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic",
          "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
      }
      .hidden {
        display: none !important;
      }
    </style>
  </head>
  <body class="min-h-screen">
    <!-- Login Screen -->
    <div
      id="login-screen"
      class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900"
    >
      <div
        class="bg-slate-800 p-8 rounded-2xl shadow-xl max-w-sm w-full border border-slate-700 m-4"
      >
        <div class="flex justify-center mb-6">
          <div class="bg-red-500/10 p-4 rounded-full">
            <i data-lucide="shield-check" class="w-10 h-10 text-red-500"></i>
          </div>
        </div>
        <h2 class="text-xl font-bold mb-6 text-center text-white">
          ë£¨ì‹œë”” ê´€ë¦¬ì ë¡œê·¸ì¸
        </h2>
        <button
          id="google-login-btn"
          class="w-full bg-white text-black py-3.5 rounded-xl font-bold flex items-center justify-center gap-3 hover:bg-gray-200 transition-colors"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 48 48"
            width="20px"
            height="20px"
          >
            <path
              fill="#FFC107"
              d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"
            />
            <path
              fill="#FF3D00"
              d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"
            />
            <path
              fill="#4CAF50"
              d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"
            />
            <path
              fill="#1976D2"
              d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"
            />
          </svg>
          Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
        </button>
        <p class="text-xs text-slate-400 mt-4 text-center">
          ë“±ë¡ëœ ë§ˆìŠ¤í„° ê³„ì •ë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.
        </p>
      </div>
    </div>

    <!-- Dashboard Main -->
    <div id="dashboard-screen" class="hidden h-screen overflow-hidden">
      <!-- Sidebar -->
      <aside class="w-64 bg-slate-800 border-r border-slate-700 flex flex-col">
        <div class="p-6 border-b border-slate-700">
          <h1 class="text-xl font-bold text-red-400 flex items-center gap-2">
            <i data-lucide="shield-check" class="w-6 h-6"></i> ë£¨ì‹œë”” ê´€ë¦¬ì
          </h1>
        </div>
        <nav class="flex-1 p-4 space-y-2">
          <button
            data-target="section-config"
            class="nav-tab w-full flex items-center gap-3 px-4 py-3 bg-red-500/10 text-red-400 font-bold rounded-lg text-left transition-colors"
          >
            <i data-lucide="smartphone" class="w-5 h-5"></i> ì•± ì—…ë°ì´íŠ¸ ê´€ë¦¬
          </button>
          <button
            data-target="section-reports"
            class="nav-tab w-full flex items-center gap-3 px-4 py-3 hover:bg-slate-700/50 text-slate-300 rounded-lg text-left transition-colors"
          >
            <i data-lucide="flag" class="w-5 h-5"></i> ì‹ ê³  ë‚´ì—­ ê´€ë¦¬
          </button>
          <button
            data-target="section-blacklist"
            class="nav-tab w-full flex items-center gap-3 px-4 py-3 hover:bg-slate-700/50 text-slate-300 rounded-lg text-left transition-colors"
          >
            <i data-lucide="users" class="w-5 h-5"></i> ë¸”ë™ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬
          </button>
        </nav>
        <div class="p-4 border-t border-slate-700">
          <button
            id="logout-btn"
            class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-slate-700/50 hover:bg-slate-700 rounded-lg text-sm text-white font-bold transition-colors"
          >
            <i data-lucide="log-out" class="w-4 h-4"></i> ë¡œê·¸ì•„ì›ƒ
          </button>
        </div>
      </aside>

      <!-- Main Content Area -->
      <main class="flex-1 overflow-y-auto p-8 bg-slate-900">
        <!-- ì•± ì—…ë°ì´íŠ¸ ê´€ë¦¬ ì„¹ì…˜ -->
        <section id="section-config" class="content-section max-w-2xl mx-auto">
          <h2 class="text-2xl font-bold mb-8 flex items-center gap-2">
            <i data-lucide="smartphone" class="w-7 h-7 text-red-400"></i>
            ì•± ê°•ì œ ì—…ë°ì´íŠ¸ ê´€ë¦¬
          </h2>

          <div
            class="bg-slate-800 rounded-2xl border border-slate-700 p-6 shadow-xl"
          >
            <div
              class="flex items-center justify-between bg-black/30 p-4 rounded-xl border border-white/5 mb-6"
            >
              <div class="flex items-center gap-3">
                <i data-lucide="info" class="w-5 h-5 text-slate-400"></i>
                <span class="text-sm text-slate-300 font-bold"
                  >í˜„ì¬ ê°•ì œ íŒì—… ë™ì‘ ìƒíƒœ</span
                >
              </div>
              <span
                id="config-status-text"
                class="text-[12px] font-bold px-3 py-1.5 rounded bg-gray-500/20 text-gray-400"
                >ì„¤ì • ì•ˆ ë¨</span
              >
            </div>

            <div class="space-y-6">
              <div>
                <label class="block text-sm text-slate-400 mb-2 font-bold"
                  >ìµœì†Œ ìš”êµ¬ ë²„ì „ (ì˜ˆ: 1.0.5)</label
                >
                <input
                  type="text"
                  id="config-version"
                  class="w-full bg-black/40 border border-slate-600 rounded-xl px-4 py-3.5 text-sm text-white outline-none focus:border-red-500 transition-colors"
                  placeholder="1.0.0"
                />
              </div>
              <div>
                <label class="block text-sm text-slate-400 mb-2 font-bold"
                  >ì—…ë°ì´íŠ¸ íŒì—… ë©”ì‹œì§€ (ì¤„ë°”ê¿ˆ ì‹œ \n ì‚¬ìš©)</label
                >
                <textarea
                  id="config-msg"
                  class="w-full bg-black/40 border border-slate-600 rounded-xl px-4 py-3.5 text-sm text-white outline-none focus:border-red-500 transition-colors h-28 resize-none leading-relaxed"
                ></textarea>
              </div>
              <div>
                <label class="block text-sm text-slate-400 mb-2 font-bold"
                  >ìŠ¤í† ì–´ ë§í¬ URL</label
                >
                <input
                  type="text"
                  id="config-url"
                  class="w-full bg-black/40 border border-slate-600 rounded-xl px-4 py-3.5 text-sm text-white outline-none focus:border-red-500 transition-colors"
                  placeholder="market://details?id=..."
                />
              </div>

              <div class="flex gap-3 pt-4">
                <button
                  id="admin-clear-btn"
                  class="flex-1 bg-slate-700 text-white rounded-xl py-4 font-bold hover:bg-slate-600 transition-colors hidden"
                >
                  ì´ˆê¸°í™” (ê°•ì œ ì¢…ë£Œ)
                </button>
                <button
                  id="admin-save-btn"
                  class="flex-1 bg-red-500 text-white rounded-xl py-4 font-bold hover:bg-red-600 transition-colors shadow-lg shadow-red-500/20"
                >
                  ìƒˆ ë²„ì „ìœ¼ë¡œ ì„¤ì • ì €ì¥
                </button>
              </div>
            </div>
          </div>
        </section>

        <!-- ì‹ ê³  ë‚´ì—­ ê´€ë¦¬ ì„¹ì…˜ -->
        <section
          id="section-reports"
          class="content-section hidden max-w-5xl mx-auto"
        >
          <div class="flex items-center justify-between mb-8">
            <h2 class="text-2xl font-bold flex items-center gap-2">
              <i data-lucide="flag" class="w-7 h-7 text-red-400"></i>
              ì‹ ê³  ë‚´ì—­ ê´€ë¦¬
            </h2>
            <button
              onclick="fetchReports()"
              class="flex items-center gap-2 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-xl text-sm font-bold transition-colors"
            >
              <i data-lucide="refresh-cw" class="w-4 h-4"></i> ìƒˆë¡œê³ ì¹¨
            </button>
          </div>
          <div id="reports-container">
            <div
              class="bg-slate-800 p-8 rounded-2xl border border-slate-700 text-center"
            >
              <i
                data-lucide="loader"
                class="w-8 h-8 text-slate-500 animate-spin mx-auto mb-4"
              ></i>
              <p class="text-slate-400">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
            </div>
          </div>
        </section>

        <!-- ë¸”ë™ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬ ì„¹ì…˜ -->
        <section
          id="section-blacklist"
          class="content-section hidden max-w-5xl mx-auto"
        >
          <div class="flex items-center justify-between mb-8">
            <h2 class="text-2xl font-bold flex items-center gap-2">
              <i data-lucide="users" class="w-7 h-7 text-red-400"></i>
              ë¸”ë™ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬
            </h2>
            <button
              onclick="fetchBlacklist()"
              class="flex items-center gap-2 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-xl text-sm font-bold transition-colors"
            >
              <i data-lucide="refresh-cw" class="w-4 h-4"></i> ìƒˆë¡œê³ ì¹¨
            </button>
          </div>
          <div id="blacklist-container">
            <div
              class="bg-slate-800 p-8 rounded-2xl border border-slate-700 text-center"
            >
              <i
                data-lucide="loader"
                class="w-8 h-8 text-slate-500 animate-spin mx-auto mb-4"
              ></i>
              <p class="text-slate-400">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
            </div>
          </div>
        </section>
      </main>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
      import {
        getAuth,
        signInWithPopup,
        GoogleAuthProvider,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
      import {
        getFirestore,
        doc,
        collection,
        getDoc,
        getDocs,
        setDoc,
        updateDoc,
        deleteDoc,
        query,
        orderBy,
        where,
      } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAsIc3kTstDICaxn1JwFOHIseP0NFUxyfk",
        authDomain: "onepicksoft-dream.firebaseapp.com",
        projectId: "onepicksoft-dream",
        storageBucket: "onepicksoft-dream.firebasestorage.app",
        messagingSenderId: "113950046877",
        appId: "1:113950046877:web:c06b5854e8c1210d007274",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const MASTER_EMAIL = "onepicksoft@gmail.com";

      // 1. Screens
      const loginScreen = document.getElementById("login-screen");
      const dashboardScreen = document.getElementById("dashboard-screen");

      // 2. Auth Logic
      let isMasterCheckDone = false;
      const googleLoginBtn = document.getElementById("google-login-btn");
      const logoutBtn = document.getElementById("logout-btn");

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          if (user.email === MASTER_EMAIL) {
            // ë§ˆìŠ¤í„° ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ëŒ€ì‹œë³´ë“œ í‘œì‹œ
            loginScreen.classList.add("hidden");
            loginScreen.classList.remove("flex");
            dashboardScreen.classList.remove("hidden");
            dashboardScreen.classList.add("flex");
            loadConfig();
            isMasterCheckDone = true;
          } else {
            // ë§ˆìŠ¤í„°ê°€ ì•„ë‹Œ ê²½ìš° íŠ•ê¹€
            if (isMasterCheckDone) return; // ì¤‘ë³µ ì•ŒëŸ¿ ë°©ì§€
            isMasterCheckDone = true;
            loginScreen.classList.remove("hidden");
            loginScreen.classList.add("flex");
            dashboardScreen.classList.add("hidden");
            dashboardScreen.classList.remove("flex");
            alert("ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ë§ˆìŠ¤í„° ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
            await signOut(auth);
          }
        } else {
          isMasterCheckDone = false; // ë¡œê·¸ì•„ì›ƒìƒíƒœ
          loginScreen.classList.remove("hidden");
          loginScreen.classList.add("flex");
          dashboardScreen.classList.add("hidden");
          dashboardScreen.classList.remove("flex");
        }
      });

      googleLoginBtn.addEventListener("click", async () => {
        try {
          const provider = new GoogleAuthProvider();
          await signInWithPopup(auth, provider);
        } catch (e) {
          if (e.code !== "auth/popup-closed-by-user") {
            alert("ë¡œê·¸ì¸ ì¤‘ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            console.error(e);
          }
        }
      });

      logoutBtn.addEventListener("click", async () => {
        await signOut(auth);
      });

      // 3. Tab Switching Logic
      const tabs = document.querySelectorAll(".nav-tab");
      const sections = document.querySelectorAll(".content-section");

      tabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          // ëª¨ë“  íƒ­ í•´ì œ
          tabs.forEach((t) => {
            t.className =
              "nav-tab w-full flex items-center gap-3 px-4 py-3 hover:bg-slate-700/50 text-slate-300 rounded-lg text-left transition-colors";
          });
          // í´ë¦­ íƒ­ í™œì„±í™”
          tab.className =
            "nav-tab w-full flex items-center gap-3 px-4 py-3 bg-red-500/10 text-red-400 font-bold rounded-lg text-left transition-colors";

          // í•´ë‹¹ ì„¹ì…˜ í™œì„±í™”
          const targetId = tab.getAttribute("data-target");
          sections.forEach((sec) => {
            if (sec.id === targetId) {
              sec.classList.remove("hidden");
            } else {
              sec.classList.add("hidden");
            }
          });

          // ì„¹ì…˜ ë°ì´í„° ë¡œë“œ
          if (targetId === "section-reports") fetchReports();
          if (targetId === "section-blacklist") fetchBlacklist();
        });
      });

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // 5. ì‹ ê³  ë‚´ì—­ ê´€ë¦¬
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function formatDate(val) {
        if (!val) return "-";
        const d = val?.toDate ? val.toDate() : new Date(val);
        return d.toLocaleString("ko-KR");
      }

      window.fetchReports = async function () {
        const container = document.getElementById("reports-container");
        container.innerHTML = `<div class="bg-slate-800 p-8 rounded-2xl border border-slate-700 text-center">
          <div class="w-8 h-8 border-2 border-red-400 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
          <p class="text-slate-400">ì‹ ê³  ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>`;
        try {
          const q = query(
            collection(db, "reports"),
            orderBy("createdAt", "desc"),
          );
          const snap = await getDocs(q);
          const reports = snap.docs.map((d) => ({ id: d.id, ...d.data() }));

          if (reports.length === 0) {
            container.innerHTML = `<div class="bg-slate-800 p-12 rounded-2xl border border-slate-700 text-center">
              <p class="text-4xl mb-3">âœ…</p><p class="text-slate-400">ì‹ ê³  ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p></div>`;
            return;
          }

          const pending = reports.filter(
            (r) => r.status === "pending" || !r.status,
          );
          const resolved = reports.filter((r) => r.status === "resolved");

          let html = "";
          if (pending.length > 0) {
            html += `<p class="text-xs text-red-400 font-bold uppercase tracking-wider mb-2">ë¯¸ì²˜ë¦¬ (${pending.length})</p>`;
            html += pending.map((r) => renderReportCard(r, false)).join("");
          }
          if (resolved.length > 0) {
            html += `<p class="text-xs text-slate-500 font-bold uppercase tracking-wider mt-6 mb-2">ì²˜ë¦¬ ì™„ë£Œ (${resolved.length})</p>`;
            html += resolved.map((r) => renderReportCard(r, true)).join("");
          }
          container.innerHTML = `<div class="space-y-3">${html}</div>`;
        } catch (e) {
          console.error(e);
          container.innerHTML = `<div class="bg-slate-800 p-8 rounded-2xl border border-red-500/20 text-center"><p class="text-red-400">âš ï¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${e.message}</p></div>`;
        }
      };

      function renderReportCard(r, resolved) {
        const borderColor = resolved ? "border-slate-700" : "border-red-500/20";
        const bgColor = resolved ? "bg-slate-800/50" : "bg-slate-800";
        const typeLabel = r.type === "post" ? "ğŸ“„ ê²Œì‹œê¸€ ì‹ ê³ " : "ğŸ’¬ ëŒ“ê¸€ ì‹ ê³ ";
        const resolveBtn = !resolved
          ? `<button onclick="resolveReport('${r.id}')" class="flex-1 py-2 rounded-xl bg-green-500/15 border border-green-500/30 text-green-400 text-xs font-bold hover:bg-green-500/25 transition-all">âœ… ì²˜ë¦¬ ì™„ë£Œ</button>`
          : "";
        const detailRows = [
          r.postTitle
            ? `<p class="text-xs text-slate-400">ğŸ“ ì œëª©: <span class="text-white/70">${r.postTitle}</span></p>`
            : "",
          r.commentContent
            ? `<p class="text-xs text-slate-400">ğŸ’¬ ëŒ“ê¸€: <span class="text-white/70">${r.commentContent}</span></p>`
            : "",
          r.author
            ? `<p class="text-xs text-slate-400">âœï¸ ì‘ì„±ì: <span class="text-white/70">${r.author}</span></p>`
            : "",
          r.reporterUid
            ? `<p class="text-xs text-slate-400">ğŸ‘¤ ì‹ ê³ ì UID: <span class="text-slate-500 font-mono text-[10px]">${r.reporterUid}</span></p>`
            : "",
          r.postId
            ? `<p class="text-xs text-slate-400">ğŸ†” ê²Œì‹œê¸€ ID: <span class="text-slate-500 font-mono text-[10px]">${r.postId}</span></p>`
            : "",
        ].join("");

        return `
          <div class="rounded-2xl border ${borderColor} ${bgColor} overflow-hidden mb-2">
            <div class="p-4">
              <div class="flex items-start justify-between gap-3 mb-3">
                <div>
                  <p class="text-sm font-bold ${
                    resolved ? "text-white/40" : "text-white"
                  }">${typeLabel} Â· ${r.reason || "ì‚¬ìœ  ì—†ìŒ"}</p>
                  <p class="text-[11px] text-slate-500 mt-0.5">${formatDate(
                    r.createdAt,
                  )}</p>
                </div>
                <span class="text-[10px] px-2 py-1 rounded-full font-bold ${
                  resolved
                    ? "bg-green-500/10 text-green-400"
                    : "bg-red-500/10 text-red-400"
                }">${resolved ? "ì²˜ë¦¬ì™„ë£Œ" : "ë¯¸ì²˜ë¦¬"}</span>
              </div>
              <div class="space-y-1 mb-3 p-3 bg-black/20 rounded-xl">${detailRows}</div>
              <div class="flex gap-2">
                ${resolveBtn}
                <button onclick="deleteReport('${
                  r.id
                }')" class="flex-1 py-2 rounded-xl bg-red-500/10 border border-red-500/20 text-red-400 text-xs font-bold hover:bg-red-500/20 transition-all">ğŸ—‘ï¸ ì‚­ì œ</button>
              </div>
            </div>
          </div>`;
      }

      window.resolveReport = async function (reportId) {
        if (!confirm("ì´ ì‹ ê³ ë¥¼ ì²˜ë¦¬ ì™„ë£Œë¡œ í‘œì‹œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        try {
          await updateDoc(doc(db, "reports", reportId), { status: "resolved" });
          await fetchReports();
        } catch (e) {
          alert("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: " + e.message);
        }
      };

      window.deleteReport = async function (reportId) {
        if (!confirm("ì´ ì‹ ê³  ê¸°ë¡ì„ ì˜êµ¬ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        try {
          await deleteDoc(doc(db, "reports", reportId));
          await fetchReports();
        } catch (e) {
          alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜: " + e.message);
        }
      };

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // 6. ë¸”ë™ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      window.fetchBlacklist = async function () {
        const container = document.getElementById("blacklist-container");
        container.innerHTML = `<div class="bg-slate-800 p-8 rounded-2xl border border-slate-700 text-center">
          <div class="w-8 h-8 border-2 border-red-400 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
          <p class="text-slate-400">ë¸”ë™ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>`;
        try {
          const q = query(
            collection(db, "users"),
            where("blacklistedUntil", "!=", null),
          );
          const snap = await getDocs(q);
          const now = new Date();
          const users = snap.docs
            .map((d) => ({ uid: d.id, ...d.data() }))
            .filter(
              (u) => u.blacklistedUntil && new Date(u.blacklistedUntil) > now,
            );

          if (users.length === 0) {
            container.innerHTML = `<div class="bg-slate-800 p-12 rounded-2xl border border-slate-700 text-center">
              <p class="text-4xl mb-3">ğŸ‰</p><p class="text-slate-400">í˜„ì¬ í™œì„± ë¸”ë™ë¦¬ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>`;
            return;
          }

          const html = users
            .map(
              (u) => `
            <div class="bg-slate-800 border border-red-500/20 rounded-2xl p-4 mb-3">
              <div class="flex items-start justify-between gap-3">
                <div class="flex-1 min-w-0">
                  <p class="font-bold text-white">${
                    u.nickname || u.displayName || "ì•Œ ìˆ˜ ì—†ìŒ"
                  }</p>
                  <p class="text-[10px] font-mono text-slate-500 truncate">UID: ${
                    u.uid
                  }</p>
                  <p class="text-xs text-red-300/70 mt-1">ğŸš« ì‚¬ìœ : ${
                    u.blacklistReason || "-"
                  }</p>
                  <p class="text-xs text-slate-500 mt-0.5">â± í•´ì œì¼: ${formatDate(
                    u.blacklistedUntil,
                  )}</p>
                  ${
                    u.blacklistContent
                      ? `<div class="mt-2 p-2 bg-red-500/5 border border-red-500/10 rounded-lg"><p class="text-[11px] text-red-200/60 whitespace-pre-wrap">${u.blacklistContent}</p></div>`
                      : ""
                  }
                </div>
                <button onclick="liftBan('${u.uid}', '${(
                u.nickname ||
                u.displayName ||
                "ìœ ì €"
              ).replace(/'/g, "\\'")}')"
                  class="flex items-center gap-1.5 px-3 py-2 bg-green-500/20 border border-green-500/30 text-green-400 text-xs font-bold rounded-xl hover:bg-green-500/30 transition-all flex-shrink-0">
                  ğŸ”“ í•´ì œ
                </button>
              </div>
            </div>`,
            )
            .join("");
          container.innerHTML = html;
        } catch (e) {
          console.error(e);
          container.innerHTML = `<div class="bg-slate-800 p-8 rounded-2xl border border-red-500/20 text-center"><p class="text-red-400">âš ï¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${e.message}</p></div>`;
        }
      };

      window.liftBan = async function (uid, nickname) {
        if (!confirm(`[${nickname}] ìœ ì €ì˜ ë¸”ë™ë¦¬ìŠ¤íŠ¸ë¥¼ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`))
          return;
        try {
          await updateDoc(doc(db, "users", uid), {
            blacklistedUntil: null,
            blacklistReason: null,
          });
          alert(`[${nickname}] ë¸”ë™ë¦¬ìŠ¤íŠ¸ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
          await fetchBlacklist();
        } catch (e) {
          alert("í•´ì œ ì¤‘ ì˜¤ë¥˜: " + e.message);
        }
      };

      // 4. App Update Config Logic
      const vInput = document.getElementById("config-version");
      const mInput = document.getElementById("config-msg");
      const uInput = document.getElementById("config-url");
      const saveBtn = document.getElementById("admin-save-btn");
      const clearBtn = document.getElementById("admin-clear-btn");
      const statusText = document.getElementById("config-status-text");

      function updateStatusUI(isActive) {
        if (isActive) {
          statusText.innerHTML = "ğŸŸ¢ íŒì—… ë™ì‘ ì¤‘";
          statusText.className =
            "text-[12px] font-bold px-3 py-1.5 rounded bg-green-500/20 text-green-400";
          saveBtn.classList.add("hidden");
          clearBtn.classList.remove("hidden");
        } else {
          statusText.innerHTML = "âš« ì„¤ì • í•´ì œë¨";
          statusText.className =
            "text-[12px] font-bold px-3 py-1.5 rounded bg-gray-500/20 text-gray-400";
          saveBtn.classList.remove("hidden");
          clearBtn.classList.add("hidden");
        }
      }

      async function loadConfig() {
        try {
          saveBtn.textContent = "ë¡œë”© ì¤‘...";
          const snap = await getDoc(doc(db, "settings", "app_config"));
          if (snap.exists()) {
            const data = snap.data();
            vInput.value = data.minVersion || "";
            mInput.value = data.updateMessage || "";
            uInput.value = data.storeUrl || "";
            updateStatusUI(!!data.minVersion);
          } else {
            updateStatusUI(false);
          }
        } catch (e) {
          console.error("Config Load Failed", e);
        } finally {
          saveBtn.textContent = "ìƒˆ ë²„ì „ìœ¼ë¡œ ì„¤ì • ì €ì¥";
        }
      }

      saveBtn.addEventListener("click", async () => {
        try {
          saveBtn.textContent = "ì €ì¥ ì¤‘...";
          await setDoc(
            doc(db, "settings", "app_config"),
            {
              minVersion: vInput.value,
              updateMessage: mInput.value,
              storeUrl: uInput.value,
            },
            { merge: true },
          );
          alert(
            "ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ì´ì œ ê¸°ê¸°ì˜ ë²„ì „ì´ ì´ë³´ë‹¤ ë‚®ìœ¼ë©´ íŒì—…ì´ ì°¨ë‹¨í•©ë‹ˆë‹¤.",
          );
          updateStatusUI(true);
        } catch (e) {
          console.error(e);
          alert("ì €ì¥ ì‹¤íŒ¨");
        } finally {
          saveBtn.textContent = "ìƒˆ ë²„ì „ìœ¼ë¡œ ì„¤ì • ì €ì¥";
        }
      });

      clearBtn.addEventListener("click", async () => {
        try {
          clearBtn.textContent = "ì²˜ë¦¬ ì¤‘...";
          await setDoc(
            doc(db, "settings", "app_config"),
            {
              minVersion: "",
              updateMessage:
                "ìƒˆë¡œìš´ ë²„ì „ì´ í•„ìš”í•©ë‹ˆë‹¤.\nìŠ¤í† ì–´ì—ì„œ ì—…ë°ì´íŠ¸í•´ì£¼ì„¸ìš”.",
              storeUrl: "market://details?id=com.onepicksoft.dream",
            },
            { merge: true },
          );
          alert("ê°•ì œ ì—…ë°ì´íŠ¸ íŒì—…ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
          vInput.value = "";
          mInput.value =
            "ìƒˆë¡œìš´ ë²„ì „ì´ í•„ìš”í•©ë‹ˆë‹¤.\nìŠ¤í† ì–´ì—ì„œ ì—…ë°ì´íŠ¸í•´ì£¼ì„¸ìš”.";
          uInput.value = "market://details?id=com.onepicksoft.dream";
          updateStatusUI(false);
        } catch (e) {
          console.error(e);
          alert("í•´ì œ ì‹¤íŒ¨");
        } finally {
          clearBtn.textContent = "ì´ˆê¸°í™” (ê°•ì œ ì¢…ë£Œ)";
        }
      });

      // Init Icons
      lucide.createIcons();
    </script>
  </body>
</html>
